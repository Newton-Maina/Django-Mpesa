{% extends 'layout.html' %}
{% load static %}

{% block extra_css %}
<style>
:root {
    --token-card-bg: rgba(255, 255, 255, 0.05);
    --token-card-border: rgba(255, 255, 255, 0.1);
}

/* Token card enhancements */
.token-card {
    transition: all 0.3s ease;
    animation: fadeInUp 0.6s ease-out;
    background: var(--token-card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--token-card-border);
}

.token-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 255, 136, 0.15);
    border-color: rgba(0, 255, 136, 0.3);
}

/* Tab button enhancements */
.tab-btn {
    transition: all 0.2s ease;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-weight: 500;
    position: relative;
    overflow: hidden;
}

.tab-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.5s ease;
}

.tab-btn:hover::before {
    left: 100%;
}

.tab-btn.active {
    background: linear-gradient(135deg, #00ff88, #00d4ff);
    color: #000 !important;
    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
    font-weight: 600;
}

.tab-btn:not(.active):hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.08);
    color: #fff !important;
}

/* Button improvements */
.btn-action {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem 1.25rem;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.btn-action i {
    font-size: 1.1rem;
}

.btn-action small {
    font-size: 0.75rem;
    opacity: 0.9;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
}

/* Token textarea styling */
#token-value {
    background: rgba(0, 0, 0, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #00ff88;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 0.9rem;
    resize: none;
    border-radius: 8px;
    padding: 1rem;
    line-height: 1.6;
}

#token-value:focus {
    outline: none;
    border-color: rgba(0, 255, 136, 0.5);
    box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
}

/* Code block styling */
pre {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 1.5rem;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 0.85rem;
    color: #e0e0e0;
    overflow-x: auto;
    margin: 0;
}

code {
    color: #00ff88;
    text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
}

/* Info grid styling */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-item strong {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-item span {
    color: #00ff88;
    font-weight: 500;
}

/* Status badge */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 20px;
    color: #00ff88;
    font-weight: 600;
}

.status-badge::before {
    content: '';
    width: 8px;
    height: 8px;
    background: #00ff88;
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
}

/* Alert styling */
.alert-custom {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 10px;
    color: #ffc107;
}

.alert-custom i {
    color: #ffc107;
}

/* Gradient text */
.gradient-text {
    background: linear-gradient(135deg, #00ff88, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    pre {
        padding: 1rem;
        font-size: 0.75rem;
    }

    .tab-btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
    }

    .btn-action {
        padding: 0.6rem 1rem;
    }

    .btn-action small {
        font-size: 0.7rem;
    }

    .info-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    #token-value {
        font-size: 0.75rem;
    }
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
    }
    50% {
        opacity: 0.8;
        box-shadow: 0 0 0 6px rgba(0, 255, 136, 0);
    }
}

/* Tab content */
.tab-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}

{% block body %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold mb-3">
            <span class="gradient-text"><i class="fas fa-key me-2"></i>M-Pesa Access Token</span>
        </h1>
        <p class="lead" style="color: rgba(255, 255, 255, 0.7);">Securely manage your authentication token for seamless API access</p>
    </div>

    <!-- Token Display Section -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10 col-xl-8">
            <div class="card token-card">
                <div class="card-body p-4">
                    <!-- Status and Actions -->
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                        <div class="status-badge">
                            <span>Live Token</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-action" onclick="refreshToken()" id="refresh-btn">
                                <i class="fas fa-sync-alt"></i>
                                <small>Refresh</small>
                            </button>
                            <button class="btn btn-primary btn-action" onclick="copyToken()" id="copy-btn">
                                <i class="fas fa-copy"></i>
                                <small>Copy Token</small>
                            </button>
                        </div>
                    </div>

                    <!-- Token Value -->
                    <div class="mb-4">
                        <label class="form-label d-flex align-items-center gap-2 mb-3" style="color: rgba(255, 255, 255, 0.8); font-weight: 600;">
                            <i class="fas fa-key"></i>
                            Bearer Token
                        </label>
                        <textarea class="form-control" id="token-value" rows="4" readonly>{{ token|default:"No token available" }}</textarea>
                    </div>

                    <!-- Token Info Grid -->
                    <div class="info-grid">
                        <div class="info-item">
                            <strong><i class="fas fa-clock me-1"></i>Generated</strong>
                            <span id="generated-time">{{ current_time|date:"M d, Y H:i:s" }}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-hourglass-half me-1"></i>Expires In</strong>
                            <span>3600 seconds</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-server me-1"></i>Environment</strong>
                            <span>Production</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-shield-alt me-1"></i>Type</strong>
                            <span>OAuth 2.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if debug_token %}
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10 col-xl-8">
            <div class="alert alert-info">
                <strong><i class="fas fa-bug me-2"></i>Debug Token:</strong> {{ debug_token }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Usage Instructions -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10 col-xl-8">
            <div class="card token-card">
                <div class="card-body p-4">
                    <h3 class="fw-bold mb-4">
                        <span class="gradient-text"><i class="fas fa-code me-2"></i>Usage Instructions</span>
                    </h3>
                    
                    <!-- Language Tabs -->
                    <div class="mb-4 d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm tab-btn active" onclick="showTab('curl')">
                            <i class="fas fa-terminal me-1"></i>cURL
                        </button>
                        <button class="btn btn-outline-primary btn-sm tab-btn" onclick="showTab('python')">
                            <i class="fab fa-python me-1"></i>Python
                        </button>
                        <button class="btn btn-outline-primary btn-sm tab-btn" onclick="showTab('javascript')">
                            <i class="fab fa-js me-1"></i>JavaScript
                        </button>
                    </div>

                    <!-- cURL Tab -->
                    <div id="curl-tab" class="tab-content">
                        <pre><code>curl -X POST 'https://api.safaricom.co.ke/mpesa/stkpush/v1/processrequest' \
-H 'Authorization: Bearer {{ token }}' \
-H 'Content-Type: application/json' \
-d '{
    "BusinessShortCode": "{{ short_code }}",
    "Password": "base64_encoded_password",
    "Timestamp": "20250911101500",
    "TransactionType": "CustomerPayBillOnline",
    "Amount": 1,
    "PartyA": "254703138300",
    "PartyB": "{{ short_code }}",
    "PhoneNumber": "254703138300",
    "CallBackURL": "{{ callback_url }}",
    "AccountReference": "Your Mpesa-Test",
    "TransactionDesc": "Payment for Your Company"
}'</code></pre>
                    </div>

                    <!-- Python Tab -->
                    <div id="python-tab" class="tab-content" style="display:none;">
                        <pre><code>import requests
import json

headers = {
    'Authorization': 'Bearer {{ token }}',
    'Content-Type': 'application/json'
}

payload = {
    "BusinessShortCode": "{{ short_code }}",
    "Password": "base64_encoded_password",
    "Timestamp": "20250911101500",
    "TransactionType": "CustomerPayBillOnline",
    "Amount": 1,
    "PartyA": "254703138300",
    "PartyB": "{{ short_code }}",
    "PhoneNumber": "254703138300",
    "CallBackURL": "{{ callback_url }}",
    "AccountReference": "Your Mpesa-Test",
    "TransactionDesc": "Payment for Your Company"
}

response = requests.post(
    'https://api.safaricom.co.ke/mpesa/stkpush/v1/processrequest',
    headers=headers,
    data=json.dumps(payload)
)

print(response.json())</code></pre>
                    </div>

                    <!-- JavaScript Tab -->
                    <div id="javascript-tab" class="tab-content" style="display:none;">
                        <pre><code>const payload = {
    "BusinessShortCode": "{{ short_code }}",
    "Password": "base64_encoded_password",
    "Timestamp": "20250911101500",
    "TransactionType": "CustomerPayBillOnline",
    "Amount": 1,
    "PartyA": "254703138300",
    "PartyB": "{{ short_code }}",
    "PhoneNumber": "254703138300",
    "CallBackURL": "{{ callback_url }}",
    "AccountReference": "Your Mpesa-Test",
    "TransactionDesc": "Payment for Your Company"
};

fetch('https://api.safaricom.co.ke/mpesa/stkpush/v1/processrequest', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer {{ token }}',
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
})
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error('Error:', error));</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Notice -->
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="alert alert-custom p-4">
                <div class="d-flex gap-3">
                    <div>
                        <i class="fas fa-shield-alt fa-2x"></i>
                    </div>
                    <div>
                        <strong class="d-block mb-2">Security Notice</strong>
                        <p class="mb-0" style="color: rgba(255, 193, 7, 0.9);">
                            Keep your access token secure and never share it publicly. Tokens expire after 1 hour. 
                            Always store tokens securely and regenerate them regularly for enhanced security.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Copy token functionality
    function copyToken() {
        const token = document.getElementById('token-value');
        navigator.clipboard.writeText(token.value).then(() => {
            const btn = document.getElementById('copy-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i><small>Copied!</small>';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
        });
    }

    // Refresh token functionality
    function refreshToken() {
        const btn = document.getElementById('refresh-btn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><small>Refreshing...</small>';
        btn.disabled = true;
        
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }

    // Tab switching functionality
    function showTab(tab) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show selected tab
        document.getElementById(tab + '-tab').style.display = 'block';
        
        // Update active button
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.tab-btn').classList.add('active');
    }

    // Expose functions to global scope
    window.copyToken = copyToken;
    window.refreshToken = refreshToken;
    window.showTab = showTab;

    // Smooth scroll for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
});
</script>
{% endblock %}